<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>İçerik | İsa Halis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/style.css" />
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body>

<style>
  body { display: none; }
  .content-wrapper { max-width: var(--max-width); margin: 3rem auto; padding: 0 1.5rem; }
  .author-name { font-size: 1.2rem; font-weight: 600; color: var(--accent); margin-bottom: 1rem; }
  .book-cover { width: 100%; max-height: 360px; object-fit: cover; border-radius: var(--radius); margin-bottom: 1.5rem; }
  .book-meta { color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem; }
  .book-desc { color: var(--muted); margin-bottom: 1.5rem; line-height: 1.6; }
  .reading-area { background: #f4f4f4; color: #1f2937; padding: 2rem; border-radius: 10px; max-width: 680px; margin: 2rem auto; }
  .comments-wrapper { max-width: 680px; margin: 2rem auto 0; }
  .comment-item { background: rgba(255,255,255,0.05); padding: 0.7rem 1rem; border-radius: 8px; margin-bottom: 0.6rem; }
  .comment-meta { font-size: 0.75rem; color: #9ca3af; margin-top: 0.3rem; }
  .edit-bar { max-width: 680px; margin: 1rem auto 0; display: flex; justify-content: flex-end; }
  .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.65); display: none; justify-content: center; align-items: center; z-index: 99999; }
  .modal-box { width: 900px; max-width: 95%; background: #ffffff; border-radius: 12px; padding: 1.5rem; }
  #quillEditor { height: 300px; }
  .modal-actions { margin-top: 1rem; display: flex; justify-content: flex-end; gap: 10px; }
</style>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, updateDoc,
    collection, addDoc, getDocs, serverTimestamp, setDoc
  } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD_0Y9D2ljwwC7pHmaYTrbwc677kwIUrgQ",
    authDomain: "isahalis.firebaseapp.com",
    projectId: "isahalis",
    storageBucket: "isahalis.firebasestorage.app",
    messagingSenderId: "33060832531",
    appId: "1:33060832531:web:31cdc1598686be16aa06e6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const params = new URLSearchParams(window.location.search);
  const bookID = params.get("id");

  let currentUser = null;
  let currentUserRole = "user";
  let quill;

  if (!bookID) document.body.innerHTML = "<p style='padding:2rem;'>Geçersiz içerik ID.</p>";

  onAuthStateChanged(auth, async (user) => {
    currentUser = user || null;

    if (user) {
      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);
      if (userSnap.exists()) currentUserRole = userSnap.data().role || "user";
    }

    await loadBook();
    await loadComments();
    await loadAverageRating();
    await loadUserRating();

    document.body.style.display = "block";

    if (currentUserRole === "editor") document.getElementById("editBar").style.display = "flex";
    if (currentUser) document.getElementById("commentFormWrapper").style.display = "block";
  });

  async function loadBook() {
    const ref = doc(db, "books", bookID);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      document.body.innerHTML = "<p style='padding:2rem;'>İçerik bulunamadı.</p>";
      return;
    }

    const b = snap.data();

    document.getElementById("bookTitle").innerText = b.title;
    document.getElementById("bookCover").src = b.cover || "assets/placeholder.jpg";
    document.getElementById("bookDesc").innerText = b.desc || "";
    document.getElementById("bookMeta").innerText =
      `${b.createdAt ? new Date(b.createdAt).toLocaleDateString() : ""} • ${b.category || ""}`;

    document.getElementById("bookFull").innerHTML = b.fullText || "";
  }

  async function loadComments() {
    const list = document.getElementById("commentList");
    list.innerHTML = "<p>Yorumlar yükleniyor...</p>";

    const snap = await getDocs(collection(db, "books", bookID, "comments"));
    list.innerHTML = "";

    snap.forEach((docItem) => {
      const c = docItem.data();
      const div = document.createElement("div");
      div.className = "comment-item";
      div.innerHTML = `
        <p>${c.text}</p>
        <p class="comment-meta">${c.userName} • ${c.createdAt ? new Date(c.createdAt.toDate()).toLocaleString() : ""}</p>
      `;
      list.appendChild(div);
    });

    if (!list.innerHTML.trim()) list.innerHTML = "<p>Henüz yorum yok.</p>";
  }

  window.submitComment = async function (e) {
    e.preventDefault();
    if (!currentUser) return alert("Yorum yazmak için giriş yapmalısınız.");

    const text = document.getElementById("commentText").value.trim();
    if (!text) return;

    await addDoc(collection(db, "books", bookID, "comments"), {
      text,
      userId: currentUser.uid,
      userName: currentUser.email,
      createdAt: serverTimestamp()
    });

    document.getElementById("commentText").value = "";
    loadComments();
  };

  /* ---------------- PUANLAMA ---------------- */

  async function loadUserRating() {
    if (!currentUser) return;

    const ref = doc(db, "books", bookID, "ratings", currentUser.uid);
    const snap = await getDoc(ref);

    if (snap.exists()) {
      const r = snap.data().rating;
      highlightStars(r);
      document.getElementById("ratingInfo").innerText = `Puanınız: ${r} ★`;
    }
  }

  function highlightStars(count) {
    let html = "";
    for (let i = 0; i < 5; i++) {
      html += `<span data-star="${i + 1}" style="font-size:2rem; cursor:pointer; color:${i < count ? "#fbbf24" : "#d1d5db"};">★</span>`;
    }
    document.getElementById("ratingStars").innerHTML = html;
  }

  window.addEventListener("click", async (e) => {
    if (!e.target.dataset.star) return;
    if (!currentUser) return alert("Puan vermek için giriş yapmalısınız.");

    const rating = Number(e.target.dataset.star);

    await setDoc(
      doc(db, "books", bookID, "ratings", currentUser.uid),
      {
        rating,
        userId: currentUser.uid,
        createdAt: serverTimestamp()
      },
      { merge: true }   // ⭐ Alt koleksiyon yoksa bile otomatik oluşturur
    );

    highlightStars(rating);
    document.getElementById("ratingInfo").innerText = `Puanınız: ${rating} ★`;
  });

  async function loadAverageRating() {
    const snap = await getDocs(collection(db, "books", bookID, "ratings"));

    let total = 0, count = 0;
    snap.forEach(r => { total += r.data().rating; count++; });

    const avg = count === 0 ? "Henüz puan yok" : (total / count).toFixed(1) + " ★";

    document.getElementById("bookMeta").innerText += ` • Ortalama Puan: ${avg}`;
  }

  /* ---------------- EDITOR ---------------- */

  window.openEditor = function () {
    document.getElementById("modalBg").style.display = "flex";
    quill = new Quill('#quillEditor', { theme: 'snow' });
    quill.root.innerHTML = document.getElementById("bookFull").innerHTML;
  };

  window.closeEditor = function () {
    document.getElementById("modalBg").style.display = "none";
  };

  window.saveEditedText = async function () {
    const newHTML = quill.root.innerHTML;
    await updateDoc(doc(db, "books", bookID), { fullText: newHTML });
    document.getElementById("bookFull").innerHTML = newHTML;
    closeEditor();
    alert("Metin güncellendi.");
  };
</script>

<header class="site-header">
  <div class="logo">İsa Halis</div>
  <nav class="nav">
    <a href="index.html">Ana Sayfa</a>
    <a href="books.html">Kitaplarım</a>
    <a href="about.html">Hakkımda</a>
    <a href="contact.html">İletişim</a>
  </nav>
</header>

<main class="content-wrapper">

  <h2 class="author-name">İsa Halis</h2>

  <img id="bookCover" class="book-cover" />

  <h1 id="bookTitle"></h1>

  <div id="bookMeta" class="book-meta"></div>

  <div id="bookDesc" class="book-desc"></div>

  <div class="reading-area" id="bookFull"></div>

  <div id="editBar" class="edit-bar" style="display:none;">
    <button class="btn-secondary" onclick="openEditor()">Metni Düzenle (Editor)</button>
  </div>

  <section class="comments-wrapper">
    <h3>Yorumlar</h3>
    <div id="commentList"></div>

    <div id="commentFormWrapper" style="display:none; margin-top:1rem;">
      <form onsubmit="submitComment(event)" class="comment-form">
        <textarea id="commentText" rows="3" placeholder="Yorumunuzu yazın..." required></textarea>
        <button type="submit" class="btn-primary">Yorumu Gönder</button>
      </form>
    </div>
  </section>

  <section class="rating-wrapper" style="max-width:680px; margin:2rem auto;">
    <h3>Kitabı Oyla</h3>
    <div id="ratingStars">★★★★★</div>
    <p id="ratingInfo" style="margin-top:0.5rem; color:#9ca3af;"></p>
  </section>

</main>

<div id="modalBg" class="modal-bg">
  <div class="modal-box">
    <h3>Metni Düzenle</h3>
    <div id="quillEditor"></div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeEditor()">İptal</button>
      <button class="btn-primary" onclick="saveEditedText()">Kaydet</button>
    </div>
  </div>
</div>

<footer class="site-footer">
  <p>© <span id="year"></span> İsa Halis</p>
</footer>

<script>
  document.getElementById("year").textContent = new Date().getFullYear();
</script>

</body>
</html>
