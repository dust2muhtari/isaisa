<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Admin Paneli | İsa Halis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/style.css" />

  <style>
    body { display: none; }

    .admin-layout {
      display: flex;
      min-height: 100vh;
      background: #050816;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .sidebar {
      width: 260px;
      background: #020617;
      border-right: 1px solid rgba(148, 163, 184, 0.2);
      padding: 1.5rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .sidebar .logo {
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .sidebar-nav button {
      width: 100%;
      text-align: left;
      padding: 0.6rem 0.8rem;
      border-radius: 0.5rem;
      border: none;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background 0.15s, color 0.15s;
    }

    .sidebar-nav button.active,
    .sidebar-nav button:hover {
      background: rgba(148, 163, 184, 0.15);
      color: #e5e7eb;
    }

    .sidebar-footer {
      margin-top: auto;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      padding-top: 1rem;
      font-size: 0.8rem;
      color: #6b7280;
    }

    .admin-main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .admin-topbar {
      height: 60px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
    }

    .admin-topbar-title {
      font-size: 1rem;
      font-weight: 500;
      color: #e5e7eb;
    }

    .admin-topbar-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .admin-topbar-right button {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: transparent;
      color: #e5e7eb;
      padding: 0.3rem 0.9rem;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .admin-content {
      padding: 1.5rem;
      overflow-y: auto;
    }

    .section { display: none; }
    .section.active { display: block; }

    .cards-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.15), rgba(15,23,42,1));
      border-radius: 0.9rem;
      padding: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .stat-label {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 0.3rem;
    }

    .stat-value {
      font-size: 1.4rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    .card {
      background: rgba(15,23,42,0.9);
      border-radius: 0.9rem;
      padding: 1.2rem;
      border: 1px solid rgba(148, 163, 184, 0.3);
      margin-bottom: 1.5rem;
    }

    .card h3 {
      margin-bottom: 0.8rem;
      font-size: 1rem;
      color: #e5e7eb;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      font-size: 0.85rem;
    }

    .form-group input {
      background: #020617;
      border-radius: 0.5rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 0.45rem 0.6rem;
      color: #e5e7eb;
      font-size: 0.85rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 999px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .btn-secondary {
      background: transparent;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: #e5e7eb;
      padding: 0.4rem 0.9rem;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .btn-danger {
      background: transparent;
      border-radius: 999px;
      border: 1px solid rgba(248, 113, 113, 0.8);
      color: #fecaca;
      padding: 0.4rem 0.9rem;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .table-wrapper { width: 100%; overflow-x: auto; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th, td {
      padding: 0.5rem 0.6rem;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      text-align: left;
      white-space: nowrap;
    }

    th {
      color: #9ca3af;
      font-weight: 500;
      background: rgba(15,23,42,0.9);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr:nth-child(even) { background: rgba(15,23,42,0.7); }
    tr:hover { background: rgba(30,64,175,0.35); }

    @media (max-width: 768px) {
      .sidebar { display: none; }
      .admin-main { flex: 1; }
    }
  </style>
</head>

<body>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    getDocs,
    collection,
    updateDoc,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD_0Y9D2ljwwC7pHmaYTrbwc677kwIUrgQ",
    authDomain: "isahalis.firebaseapp.com",
    projectId: "isahalis",
    storageBucket: "isahalis.firebasestorage.app",
    messagingSenderId: "33060832531",
    appId: "1:33060832531:web:31cdc1598686be16aa06e6",
    measurementId: "G-2N25T885EH"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let currentUserRole = "user";

  function toast(msg) { alert(msg); }

  // ---------------- SECTION SWITCH ----------------
  window.switchSection = function (id) {
    document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
    document.getElementById(id).classList.add("active");

    document.querySelectorAll(".sidebar-nav button").forEach(btn => btn.classList.remove("active"));
    const btn = document.querySelector(`.sidebar-nav button[data-section="${id}"]`);
    if (btn) btn.classList.add("active");

    const titleMap = {
      "dashboard": "Yönetim Paneli",
      "users": "Kullanıcı Yönetimi",
      "content": "İçerik Yönetimi",
      "comments": "Yorum Yönetimi",
      "settings": "Site Ayarları",
      "profile": "Profilim"
    };
    document.getElementById("topbarTitle").innerText = titleMap[id] || "Admin Paneli";

    if (id === "comments") loadCommentsAdmin();
    if (id === "settings") loadSettings();
  };

  // ---------------- LOGOUT ----------------
  window.logout = function () {
    signOut(auth).then(() => {
      window.location.href = "login.html";
    });
  };

  // ---------------- AUTH CHECK ----------------
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    currentUser = user;
    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      toast("Kullanıcı kaydı bulunamadı.");
      window.location.href = "index.html";
      return;
    }

    const data = userSnap.data();
    currentUserRole = data.role || "user";

    if (data.banned) {
      toast("Hesabınız askıya alınmıştır.");
      await signOut(auth);
      window.location.href = "login.html";
      return;
    }

    if (currentUserRole !== "admin") {
      toast("Bu sayfaya sadece adminler erişebilir.");
      window.location.href = "index.html";
      return;
    }

    document.getElementById("adminEmail").innerText = currentUser.email || "";
    document.body.style.display = "block";

    await loadDashboardStats();
    await loadUsers();
    await loadContentList();

    switchSection("dashboard");
  });

  // ---------------- DASHBOARD ----------------
  async function loadDashboardStats() {
    const usersSnap = await getDocs(collection(db, "users"));
    const booksSnap = await getDocs(collection(db, "books"));

    let totalUsers = 0;
    let totalEditors = 0;
    let totalAdmins = 0;
    let totalBanned = 0;

    usersSnap.forEach(docItem => {
      totalUsers++;
      const u = docItem.data();
      if (u.role === "editor") totalEditors++;
      if (u.role === "admin") totalAdmins++;
      if (u.banned) totalBanned++;
    });

    document.getElementById("statTotalUsers").innerText = totalUsers;
    document.getElementById("statTotalEditors").innerText = totalEditors;
    document.getElementById("statTotalAdmins").innerText = totalAdmins;
    document.getElementById("statTotalBanned").innerText = totalBanned;
    document.getElementById("statTotalBooks").innerText = booksSnap.size;
  }

  // ---------------- USERS ----------------
  window.createUserRecord = async function (e) {
    e.preventDefault();

    const email = document.getElementById("newUserEmail").value.trim();
    const role = document.getElementById("newUserRole").value;
    const uid = document.getElementById("newUserUid").value.trim();

    if (!email || !role || !uid) {
      toast("Email, UID ve rol zorunludur.");
      return;
    }

    await setDoc(doc(db, "users", uid), {
      email,
      role,
      banned: false,
      createdAt: Date.now()
    });

    toast("Kullanıcı kaydı Firestore'a eklendi.");
    document.getElementById("newUserForm").reset();
    loadUsers();
  };

  async function loadUsers() {
    const tbody = document.getElementById("usersTableBody");
    tbody.innerHTML = "<tr><td colspan='6'>Yükleniyor...</td></tr>";

    const snap = await getDocs(collection(db, "users"));
    tbody.innerHTML = "";

    snap.forEach(docItem => {
      const u = docItem.data();
      const tr = document.createElement("tr");

      const roleClass =
        u.role === "admin" ? "badge-role-admin" :
        u.role === "editor" ? "badge-role-editor" :
        "badge-role-user";

      const bannedClass = u.banned ? "badge-ban-true" : "badge-ban-false";

      const createdAt = u.createdAt
        ? new Date(u.createdAt).toLocaleString()
        : "-";

      tr.innerHTML = `
        <td>${u.email || "-"}</td>
        <td><span class="badge ${roleClass}">${u.role || "user"}</span></td>
        <td><span class="badge ${bannedClass}">${u.banned ? "Banlı" : "Aktif"}</span></td>
        <td>${createdAt}</td>
        <td>${docItem.id}</td>
        <td>
          <button class="btn-secondary" onclick="changeUserRole('${docItem.id}')">Rol Değiştir</button>
          <button class="btn-secondary" onclick="toggleBanUser('${docItem.id}')">${u.banned ? "Banı Kaldır" : "Banla"}</button>
          <button class="btn-danger" onclick="deleteUserRecord('${docItem.id}')">Sil</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    if (!tbody.innerHTML.trim()) {
      tbody.innerHTML = "<tr><td colspan='6'>Kayıtlı kullanıcı bulunamadı.</td></tr>";
    }
  }

  window.changeUserRole = async function (uid) {
    const newRole = prompt("Yeni rolü girin (admin/editor/user):");
    if (!newRole) return;
    const role = newRole.trim().toLowerCase();
    if (!["admin", "editor", "user"].includes(role)) {
      toast("Geçersiz rol.");
      return;
    }
    await updateDoc(doc(db, "users", uid), { role });
    toast("Rol güncellendi.");
    loadUsers();
  };

  window.toggleBanUser = async function (uid) {
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) return;
    const u = snap.data();
    const newBan = !u.banned;
    await updateDoc(ref, { banned: newBan });
    toast(newBan ? "Kullanıcı banlandı." : "Kullanıcının banı kaldırıldı.");
    loadUsers();
  };

  window.deleteUserRecord = async function (uid) {
    if (!confirm("Bu kullanıcı kaydını silmek istediğinize emin misiniz?")) return;
    await deleteDoc(doc(db, "users", uid));
    toast("Kullanıcı kaydı silindi.");
    loadUsers();
  };

  // ---------------- CONTENT ----------------
  async function loadContentList() {
    const list = document.getElementById("contentList");
    list.innerHTML = "<p>İçerikler yükleniyor...</p>";

    const snap = await getDocs(collection(db, "books"));
    list.innerHTML = "";

    snap.forEach(docItem => {
      const b = docItem.data();
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <h3>${b.title || "Başlıksız"}</h3>
        <p style="font-size:0.8rem; color:#9ca3af;">
          Kategori: ${b.category || "-"} • 
          Tarih: ${b.createdAt ? new Date(b.createdAt).toLocaleDateString() : "-"}
        </p>
        <button class="btn-secondary" onclick="window.open('book.html?id=${docItem.id}', '_blank')">Görüntüle</button>
        <button class="btn-secondary"
